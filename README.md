# Домашнее задание №4 - трекинг объектов
## Метод tracker_soft
Основные принципы работы:

- Трекинг объектов происходит по центроиду ограничивающей рамки (bounding_box) объекта.

- Для сопоставления объектов между кадрами используется евклидово расстояние между центрами объектов.
Было выбрано евклидово расстояние, а не iou, тк объекты могут двигаться быстро, и таком случае будет сложно оценить пересенчие их боксов. ТАкже введено ограничение на расстояние, чтобы не ассоциировать объекты и треки на противоположных концах фрейма.

- На каждом новом кадре:

    - Для объектов с детекцией подбирается наиболее близкий по положению предыдущий трек (track_id). Близость смотрится по евклидовому расстоянию между центроидами объектов. Если подходящий трек находится, то мы сопоставляем наш объект с найденным best_id, и убираем этот айди из истории, чтобы не сматчить к нему другой объект.

    - Если подходящего трека нет (объект новый или сильно переместился на расстояние, большее, чем трешхолд), создаётся новый track_id.

    - Для объектов без рамки подбирается трек с максимальным оставшимся временем жизни (ttl — time-to-live). Предполагается, что треки с максимальным временем жизни появились недавно и возможно более стабильны.

- В случае пропадания объекта без деткции, его ttl уменьшается каждый кадр, чтобы постепенно освободить место в истории для новых объектов.

## Метод tracker_strong

Основные принципы работы:

- Используется модель DeepSORT:

- Сначала извлекаются эмбеддинги объектов из изображения в вырезанных областях (bounding_box). Эти эмбеддинги позволяют лучше сопоставлять объекты даже при изменении положения, масштаба и частичных перекрытиях.

- При наличии рамки:

    - Проводится обновление DeepSORT, сопоставление треков по ID и выбор ближайшего трека.

    - Для объектов без рамки:

- Реализован дополнительный трекер по ttl, аналогичный tracker_soft.

- Также следит за временем жизни треков без рамок, чтобы избегать ложных сопоставлений.


# Сравнение результатов
Для сранвения трекеров использовались метрики:
-  `ID Precision` - точность соответствия track_id реальному cb_id. Показывает, насколько точно отслеживаемый объект совпадает с его реальной меткой. Чем выше, тем лучше.
- `ID Switch `Count` - количество переключений track_id между объектами. Показывает количество раз, когда один объект в кадре был отслежен разными идентификаторами. Чем меньше, тем лучше
- `Mismatch Ratio` - измеряет количество ошибок (несоответствий) при привязке трека к объекту в кадре. Рассчитывается как $$\frac{количество ~переключений}{количество ~детекций}$$ Чем меньше, тем лучше.

Для сравнения трекеры были протестированы с диапазоном значений:
- `track_count` = [5, 10, 20]
- `random_range` = [2, 5]
- `bb_skip_percent` = [0.2, 0.4]

Расчет метрик реализован в файле `metrics.py`.

## Подготовка к тестированию
Необходимые треки были сгенерированы с помощью скрипта `generate_tracks.py`. В нем с разными аргументами вызвается скрипт `create_track_w_args.py` - модифицированная версия скрипта `create_track.py`. Результаты записываются в файл с соответсвуующим названием: `./obj{track_count}/obj{track_count}_{random_range}_{bb_skip_percent}.py`

Для метода tracker_strong были сохранены фреймы для каждой комбинации параметров. Для сохранения фреймов использовался закомментированный метод в конце файла `fastapi_server.py`. Фрйемы сохранялись в папку с соответсвующим названием: `./obj{track_count}/obj{track_count}_{random_range}_{bb_skip_percent}/`
### tracker_soft

| Объекты | random_range | bb_skip_percent | ID Precision | ID Switch Count | Mismatch Ratio |
|:-------:|:------------:|:---------------:|:------------:|:---------------:|:--------------:|
|   5     |      2       |       0.2       |   0.69948    |       96        |     0.59627    |
|   5     |      2       |       0.4       |   0.62778    |      112        |     1.02752    |
|   5     |      5       |       0.2       |   0.62147    |       94        |     0.69630    |
|   5     |      5       |       0.4       |   0.56051    |       83        |     0.90217    |
|  10     |      2       |       0.2       |   0.50000    |      177        |     0.67045    |
|  10     |      2       |       0.4       |   0.49838    |      217        |     1.11856    |
|  10     |      5       |       0.2       |   0.54341    |      185        |     0.72835    |
|  10     |      5       |       0.4       |   0.50565    |      261        |     1.24880    |
|  20     |      2       |       0.2       |   0.45882    |      498        |     0.79680    |
|  20     |      2       |       0.4       |   0.36684    |      592        |     1.32438    |
|  20     |      5       |       0.2       |   0.39484    |      495        |     0.85492    |
|  20     |      5       |       0.4       |   0.38005    |      563        |     1.23465    |

Видим, что с ростом количества объектов на фрейме качество трекинга ухудшается. Также бОльшая вероятность пропуска детекции негативно влияет на трекинг - количество переключений возрастает.
### tracker_strong


| Объекты | random_range | bb_skip_percent | ID Precision | ID Switch Count | Mismatch Ratio |
|:-------:|:------------:|:---------------:|:------------:|:---------------:|:--------------:|
|   5     |      2       |       0.2       |   0.72021    |       74        |     0.45963    |
|   5     |      2       |       0.4       |   0.66111    |      120        |     1.10092    |
|   5     |      5       |       0.2       |   0.71751    |       79        |     0.58519    |
|   5     |      5       |       0.4       |   0.65605    |       98        |     1.06522    |
|  10     |      2       |       0.2       |   0.62202    |      164        |     0.62121    |
|  10     |      2       |       0.4       |   0.49515    |      206        |     1.06186    |
|  10     |      5       |       0.2       |   0.56592    |      142        |     0.55906    |
|  10     |      5       |       0.4       |   0.49718    |      232        |     1.11005    |
|  20     |      2       |       0.2       |   0.58170    |      356        |     0.56960    |
|  20     |      2       |       0.4       |   0.46084    |      562        |     1.25727    |
| 20      | 5            | 0.2             | 0.62143      | 352             | 0.60794        |
| 20      | 5            | 0.4             | 0.39353      | 542             | 1.188596       |

Видим, что `tracker_strong` работает лучше, чем `tracker_soft`, особенно это заметно для большего количества объектов на фрейме. БОльшая вероятность пропуска детекции также негативно влияет на трекинг, и в некоторых случаях больше, чем у `tracker_soft` - возможно более тонкая настройка трекера поможет добиться лучших результатов. В среднем `tracker_strong` показывает более высокую точность по сравнению с `tracker_soft` и кажется более стабильным.

При росте количества объектов в обоих трекерах стабильно падает точность ID Precision, а количество переключений и mismatch ratio увеличиваются. Это может говорить о нехватке контекста в трекинге при плотных сценах, для DeepSort проблема может решиться запуском на gpu.

В некоторых случаях у `tracker_strong` количество переключений сопоставимо или даже выше, чем у tracker_soft, но при этом его id precision остается выше — это может свидетельствовать о более качественном удержании основных треков и меньшей доле ложных ассоциаций треков.
